AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Example SAM Template compatible with the provided samconfig.toml

# Define Parameters to match 'parameter_overrides' in samconfig.toml
Parameters:
  VpcStackName:
    Type: String
    Description: Source stack name for VPC resources
  CodeSigningConfigArn:
    Type: String
    Description: The ARN of the code signing configuration
  PermissionsBoundary:
    Type: String
    Description: The ARN of the IAM permissions boundary to apply to roles
  Environment:
    Type: String
    Description: The deployment environment (e.g., dev)
  SubEnvironment:
    Type: String
    Default: none
    Description: Optional sub-environment (e.g., pr-123)

Mappings:
  EnvironmentConfiguration:
    dev:
      cloudwatchLogRetentionInDays: 7
    dev1:
      cloudwatchLogRetentionInDays: 12
    stag:
      cloudwatchLogRetentionInDays: 14
    Prod:
       cloudwatchLogRetentionInDays: 30

Conditions:
  # Must be 'dev' env AND SubEnvironment must not be 'none'
  UseSubEnvironment: !And
    - !Equals
      - !Ref Environment
      - dev
    - !Not
      - !Equals
        - !Ref SubEnvironment
        - none

# 2. Apply common configs globally
Globals:
  Function:
    PermissionsBoundary: !Ref PermissionsBoundary
    Environment:
      Variables:
        # Inject the Environment parameter into all functions
        APP_ENV: !Ref Environment

Resources:
  # Logical ID 'APIFunction' matches the key in 'signing_profiles'
  APIFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: app.handler
      Runtime: python3.11
      # Use the CodeSigningConfigArn parameter
      CodeSigningConfigArn: !Ref CodeSigningConfigArn
      Environment:
        Variables:
          # Example usage of the VpcStackName parameter
          VPC_STACK_ID: !Ref VpcStackName
          BAD_VAR: !FindInMap
            - EnvironmentConfiguration
            - !Ref SubEnvironment
            - nonExistentKey
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /test
            Method: get

  # IAM Role to demonstrate PermissionsBoundary usage
  APIFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      # Explicitly using the boundary parameter
      PermissionsBoundary: !Ref PermissionsBoundary
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # LogGroup utilizing your specific lookup patterns
  APIFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      # !Sub with !If logic in the variable map
      LogGroupName: !Sub
        - /aws/lambda/${Env}-APIFunction-lambda
        - Env: !If
            - UseSubEnvironment
            - !Ref SubEnvironment
            - !Ref Environment
      # !FindInMap using !Ref for the key
      RetentionInDays: !If
        - UseSubEnvironment
        - !FindInMap
          - EnvironmentConfiguration
          - !Ref SubEnvironment
          - cloudwatchLogRetentionInDays
        - !FindInMap
          - EnvironmentConfiguration
          - !Ref Environment
          - cloudwatchLogRetentionInDays
